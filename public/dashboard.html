<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard - Mercado Pago Links</title>
    <link rel="stylesheet" href="/css/style.css">
</head>
<body>
    <div class="container">
        <!-- Header -->
        <header class="header">
            <div class="header-content">
                <h1>üìä Dashboard</h1>
                <div class="header-actions">
                    <span class="user-info" id="userName">Carregando...</span>
                    <button onclick="logout()" class="btn-logout">Sair</button>
                </div>
            </div>
        </header>

        <!-- Main Content -->
        <main class="dashboard-main">
            <!-- Stats Cards -->
            <div class="stats-grid">
                <!-- Card Criar Link -->
                <div class="stat-card create-link-featured">
                    <div class="create-link-content">
                        <div class="create-icon">‚ûï</div>
                        <h3>Criar Link de Pagamento</h3>
                        <p>Gere um novo link para receber pagamentos</p>
                        <button onclick="window.location.href='/create-link'" class="btn-primary btn-large">
                            üîó Novo Link
                        </button>
                    </div>
                </div>

                <!-- Card Links Hoje -->
                <div class="stat-card">
                    <div class="stat-icon">üìÖ</div>
                    <div class="stat-content">
                        <h4>Links Criados Hoje</h4>
                        <p class="stat-number" id="linksToday">0</p>
                    </div>
                </div>

                <!-- Card Total Links -->
                <div class="stat-card">
                    <div class="stat-icon">üîó</div>
                    <div class="stat-content">
                        <h4>Total de Links</h4>
                        <p class="stat-number" id="totalLinks">0</p>
                    </div>
                </div>

                <!-- Card Links Pagos -->
                <div class="stat-card">
                    <div class="stat-icon">‚úÖ</div>
                    <div class="stat-content">
                        <h4>Links Pagos</h4>
                        <p class="stat-number" id="paidLinks">0</p>
                    </div>
                </div>
            </div>

            <!-- Recent Links Table -->
            <div class="card links-table-card">
                <div class="card-header">
                    <h2>üìã Links Recentes</h2>
                    <button onclick="loadLinks()" class="btn-refresh">üîÑ Atualizar</button>
                </div>
                
                <div class="table-container">
                    <table class="links-table" id="linksTable">
                        <thead>
                            <tr>
                                <th>T√≠tulo</th>
                                <th>Valor</th>
                                <th>Cliente</th>
                                <th>Status</th>
                                <th>Criado em</th>
                                <th>A√ß√µes</th>
                            </tr>
                        </thead>
                        <tbody id="linksTableBody">
                            <tr>
                                <td colspan="6" class="loading-cell">Carregando links...</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
                
                <div class="table-footer">
                    <button onclick="window.location.href='/links'" class="btn-secondary">
                        Ver Todos os Links ‚Üí
                    </button>
                </div>
            </div>
        </main>
    </div>

    <!-- Scripts -->
    <script src="/js/auth.js"></script>
    <script src="/js/utils.js"></script>
    <script>
        // Verificar autentica√ß√£o
        const token = localStorage.getItem('token');
        const userName = localStorage.getItem('userName');
        const userId = localStorage.getItem('userId');
        
        if (!token) {
            window.location.href = '/';
        }
        
        // Exibir nome do usu√°rio
        document.getElementById('userName').textContent = userName || 'Usu√°rio';

        // =====================================
        // SERVER-SENT EVENTS (SSE) - Notifica√ß√µes em tempo real
        // =====================================
        let eventSource = null;
        let reconnectTimeout = null;
        let reconnectAttempts = 0;
        const MAX_RECONNECT_ATTEMPTS = 10;
        const RECONNECT_DELAY = 3000; // 3 segundos

        // Fun√ß√£o para conectar ao SSE
        function connectToSSE() {
            console.log('[SSE] Conectando ao servidor de eventos...');
            
            // Fechar conex√£o anterior se existir
            if (eventSource) {
                eventSource.close();
            }
            
            // Criar nova conex√£o SSE
            eventSource = new EventSource('/api/events', {
                withCredentials: true
            });
            
            // Evento de conex√£o estabelecida
            eventSource.addEventListener('connected', (event) => {
                const data = JSON.parse(event.data);
                console.log('[SSE] Conectado:', data);
                reconnectAttempts = 0;
                
                // Mostrar notifica√ß√£o de conex√£o
                showNotification('‚úÖ Conectado ao servidor', 'success', 3000);
            });
            
            // Evento de atualiza√ß√£o de pagamento
            eventSource.addEventListener('payment_update', (event) => {
                const data = JSON.parse(event.data);
                console.log('[SSE] Atualiza√ß√£o de pagamento recebida:', data);
                
                // Atualizar a linha na tabela se existir
                updateLinkInTable(data.link);
                
                // Atualizar estat√≠sticas
                loadStats();
                
                // Mostrar notifica√ß√£o visual
                const statusLabel = getStatusLabel(data.status);
                const statusEmoji = data.status === 'paid' ? '‚úÖ' : 
                                   data.status === 'cancelled' ? '‚ùå' : '‚è≥';
                
                showNotification(
                    `${statusEmoji} Link "${data.link.description}" - Status: ${statusLabel}`,
                    data.status === 'paid' ? 'success' : 'info',
                    5000
                );
            });
            
            // Evento especial para pagamento completo
            eventSource.addEventListener('payment_completed', (event) => {
                const data = JSON.parse(event.data);
                console.log('[SSE] Pagamento completo:', data);
                
                // Tocar som de notifica√ß√£o (opcional)
                playNotificationSound();
                
                // Mostrar notifica√ß√£o especial
                showNotification(
                    `üéâ Pagamento Aprovado! ${formatCurrency(data.amount)} - ${data.description}`,
                    'success',
                    10000
                );
                
                // Atualizar toda a tabela para garantir sincroniza√ß√£o
                loadLinks();
                loadStats();
            });
            
            // Evento de erro
            eventSource.onerror = (error) => {
                console.error('[SSE] Erro na conex√£o:', error);
                eventSource.close();
                
                // Tentar reconectar
                if (reconnectAttempts < MAX_RECONNECT_ATTEMPTS) {
                    reconnectAttempts++;
                    console.log(`[SSE] Tentando reconectar... (${reconnectAttempts}/${MAX_RECONNECT_ATTEMPTS})`);
                    
                    clearTimeout(reconnectTimeout);
                    reconnectTimeout = setTimeout(() => {
                        connectToSSE();
                    }, RECONNECT_DELAY * reconnectAttempts);
                } else {
                    console.error('[SSE] M√°ximo de tentativas de reconex√£o atingido');
                    showNotification('‚ö†Ô∏è Conex√£o perdida. Recarregue a p√°gina.', 'error', 0);
                }
            };
            
            // Adicionar interceptador para o token de autentica√ß√£o
            const originalAddEventListener = eventSource.addEventListener;
            eventSource.addEventListener = function(type, listener, options) {
                const wrappedListener = function(event) {
                    // Adicionar token aos headers se necess√°rio
                    if (event.lastEventId) {
                        event.headers = {
                            'Authorization': `Bearer ${token}`
                        };
                    }
                    return listener.call(this, event);
                };
                return originalAddEventListener.call(this, type, wrappedListener, options);
            };
        }

        // Fun√ß√£o para mostrar notifica√ß√µes visuais
        function showNotification(message, type = 'info', duration = 5000) {
            // Remover notifica√ß√£o anterior se existir
            const existingNotification = document.querySelector('.notification-toast');
            if (existingNotification) {
                existingNotification.remove();
            }
            
            // Criar elemento de notifica√ß√£o
            const notification = document.createElement('div');
            notification.className = `notification-toast notification-${type}`;
            notification.innerHTML = `
                <div class="notification-content">
                    <span>${message}</span>
                    <button onclick="this.parentElement.parentElement.remove()" class="notification-close">√ó</button>
                </div>
            `;
            
            // Adicionar ao body
            document.body.appendChild(notification);
            
            // Animar entrada
            setTimeout(() => {
                notification.classList.add('show');
            }, 10);
            
            // Remover ap√≥s dura√ß√£o (se n√£o for 0)
            if (duration > 0) {
                setTimeout(() => {
                    notification.classList.remove('show');
                    setTimeout(() => {
                        notification.remove();
                    }, 300);
                }, duration);
            }
        }

        // Fun√ß√£o para tocar som de notifica√ß√£o
        function playNotificationSound() {
            try {
                // Criar elemento de √°udio tempor√°rio
                const audio = new Audio('data:audio/wav;base64,UklGRnoGAABXQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YQoGAACBhYqFbF1fdJivrJBhNjVgodDbq2EcBj+a2/LDciUFLIHO8tiJNwgZaLvt559NEAxQp+PwtmMcBjiR1/LMeSwFJHfH8N2QQAoUXrTp66hVFApGn+DyvmwhBTGH0fPTgjMGHm7A7+OZURE');
                audio.volume = 0.5;
                audio.play();
            } catch (error) {
                console.log('N√£o foi poss√≠vel tocar som de notifica√ß√£o:', error);
            }
        }

        // Fun√ß√£o para atualizar uma linha espec√≠fica na tabela
        function updateLinkInTable(link) {
            const tbody = document.getElementById('linksTableBody');
            const rows = tbody.querySelectorAll('tr');
            
            // Procurar a linha correspondente
            for (let row of rows) {
                const linkIdCell = row.querySelector('[data-link-id]');
                if (linkIdCell && linkIdCell.dataset.linkId === link.id) {
                    // Atualizar a linha
                    row.innerHTML = `
                        <td data-link-id="${link.id}">${truncateText(link.description, 30)}</td>
                        <td class="amount">${formatCurrency(link.amount)}</td>
                        <td>${truncateText(link.customer_name || '-', 20)}</td>
                        <td>
                            <span class="status-badge status-${link.status}">
                                ${getStatusLabel(link.status)}
                            </span>
                        </td>
                        <td>${formatDate(link.created_at)}</td>
                        <td>
                            <div class="action-buttons">
                                <button onclick="copyLink('${link.id}')" class="btn-icon" title="Copiar Link">
                                    üìã
                                </button>
                                <button onclick="viewLink('${link.id}')" class="btn-icon" title="Ver Detalhes">
                                    üëÅÔ∏è
                                </button>
                            </div>
                        </td>
                    `;
                    
                    // Adicionar efeito de destaque
                    row.classList.add('updated-row');
                    setTimeout(() => {
                        row.classList.remove('updated-row');
                    }, 2000);
                    
                    return;
                }
            }
            
            // Se n√£o encontrou a linha, recarregar toda a tabela
            loadLinks();
        }

        // Modificar a fun√ß√£o displayLinks para adicionar data-link-id
        function displayLinks(links) {
            const tbody = document.getElementById('linksTableBody');
            
            if (!links || links.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="6" class="empty-cell">
                            <p>Nenhum link criado ainda</p>
                            <button onclick="window.location.href='/create-link'" class="btn-primary">
                                Criar Primeiro Link
                            </button>
                        </td>
                    </tr>
                `;
                return;
            }

            tbody.innerHTML = links.map(link => `
                <tr>
                    <td data-link-id="${link.id}">${truncateText(link.description, 30)}</td>
                    <td class="amount">${formatCurrency(link.amount)}</td>
                    <td>${truncateText(link.customer_name || '-', 20)}</td>
                    <td>
                        <span class="status-badge status-${link.status}">
                            ${getStatusLabel(link.status)}
                        </span>
                    </td>
                    <td>${formatDate(link.created_at)}</td>
                    <td>
                        <div class="action-buttons">
                            <button onclick="copyLink('${link.id}')" class="btn-icon" title="Copiar Link">
                                üìã
                            </button>
                            <button onclick="viewLink('${link.id}')" class="btn-icon" title="Ver Detalhes">
                                üëÅÔ∏è
                            </button>
                        </div>
                    </td>
                </tr>
            `).join('');
        }

        // Obter label do status
        function getStatusLabel(status) {
            const labels = {
                'pending': 'Pendente',
                'paid': 'Pago',
                'expired': 'Expirado',
                'cancelled': 'Cancelado'
            };
            return labels[status] || status;
        }

        // Copiar link
        async function copyLink(linkId) {
            const linkUrl = `${window.location.origin}/pay/${linkId}`;
            
            try {
                await navigator.clipboard.writeText(linkUrl);
                alert('Link copiado!');
            } catch (err) {
                // Fallback para navegadores mais antigos
                const textArea = document.createElement('textarea');
                textArea.value = linkUrl;
                document.body.appendChild(textArea);
                textArea.select();
                document.execCommand('copy');
                document.body.removeChild(textArea);
                alert('Link copiado!');
            }
        }

        // Ver detalhes do link
        function viewLink(linkId) {
            // Por enquanto, apenas copiar o link
            copyLink(linkId);
        }

        // Logout
        function logout() {
            localStorage.clear();
            window.location.href = '/login';
        }

        // Inicializar dashboard
        document.addEventListener('DOMContentLoaded', () => {
            loadStats();
            loadLinks();
            
            // Conectar ao SSE
            connectToSSE();
            
            // Desconectar SSE ao sair da p√°gina
            window.addEventListener('beforeunload', () => {
                if (eventSource) {
                    eventSource.close();
                }
            });

            // Atualizar a cada 30 segundos
            setInterval(() => {
                loadStats();
                loadLinks();
            }, 30000);
        });
    </script>
</body>
</html>
