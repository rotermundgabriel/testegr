<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard - Mercado Pago Links</title>
    <link rel="stylesheet" href="/css/style.css">
</head>
<body>
    <div class="container">
        <!-- Header -->
        <header class="header">
            <div class="header-content">
                <h1>üìä Dashboard</h1>
                <div class="header-actions">
                    <span class="user-info" id="userName">Carregando...</span>
                    <button onclick="logout()" class="btn-logout">Sair</button>
                </div>
            </div>
        </header>

        <!-- Main Content -->
        <main class="dashboard-main">
            <!-- Stats Cards -->
            <div class="stats-grid">
                <!-- Card Criar Link -->
                <div class="stat-card create-link-featured">
                    <div class="create-link-content">
                        <div class="create-icon">‚ûï</div>
                        <h3>Criar Link de Pagamento</h3>
                        <p>Gere um novo link para receber pagamentos</p>
                        <button onclick="window.location.href='/create-link'" class="btn-primary btn-large">
                            üîó Novo Link
                        </button>
                    </div>
                </div>

                <!-- Card Links Hoje -->
                <div class="stat-card">
                    <div class="stat-icon">üìÖ</div>
                    <div class="stat-content">
                        <h4>Links Criados Hoje</h4>
                        <p class="stat-number" id="linksToday">0</p>
                    </div>
                </div>

                <!-- Card Total Links -->
                <div class="stat-card">
                    <div class="stat-icon">üîó</div>
                    <div class="stat-content">
                        <h4>Total de Links</h4>
                        <p class="stat-number" id="totalLinks">0</p>
                    </div>
                </div>

                <!-- Card Links Pagos -->
                <div class="stat-card">
                    <div class="stat-icon">‚úÖ</div>
                    <div class="stat-content">
                        <h4>Links Pagos</h4>
                        <p class="stat-number" id="paidLinks">0</p>
                    </div>
                </div>
            </div>

            <!-- Recent Links Table -->
            <div class="card links-table-card">
                <div class="card-header">
                    <h2>üìã Links Recentes</h2>
                    <button onclick="loadLinks()" class="btn-refresh">üîÑ Atualizar</button>
                </div>
                
                <div class="table-container">
                    <table class="links-table" id="linksTable">
                        <thead>
                            <tr>
                                <th>T√≠tulo</th>
                                <th>Valor</th>
                                <th>Cliente</th>
                                <th>Status</th>
                                <th>Criado em</th>
                                <th>A√ß√µes</th>
                            </tr>
                        </thead>
                        <tbody id="linksTableBody">
                            <tr>
                                <td colspan="6" class="loading-cell">Carregando links...</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
                
                <div class="table-footer">
                    <button onclick="window.location.href='/links'" class="btn-secondary">
                        Ver Todos os Links ‚Üí
                    </button>
                </div>
            </div>
        </main>
    </div>

    <!-- Scripts -->
    <script src="/js/auth.js"></script>
    <script src="/js/utils.js"></script>
    <script>
        // Verificar autentica√ß√£o
        const token = localStorage.getItem('token');
        if (!token) {
            window.location.href = '/login';
        }

        // Carregar dados do usu√°rio
        async function loadUserData() {
            const user = JSON.parse(localStorage.getItem('user') || '{}');
            document.getElementById('userName').textContent = user.name || 'Usu√°rio';
        }

        // Carregar estat√≠sticas
        async function loadStats() {
            try {
                const response = await fetch('/api/payment-links/stats', {
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('token')}`
                    }
                });

                if (response.ok) {
                    const stats = await response.json();
                    document.getElementById('linksToday').textContent = stats.today || '0';
                    document.getElementById('totalLinks').textContent = stats.total || '0';
                    document.getElementById('paidLinks').textContent = stats.paid || '0';
                }
            } catch (error) {
                console.error('Erro ao carregar estat√≠sticas:', error);
            }
        }

        // Carregar links recentes
        async function loadLinks() {
            const tbody = document.getElementById('linksTableBody');
            tbody.innerHTML = '<tr><td colspan="6" class="loading-cell">Carregando...</td></tr>';

            try {
                const response = await fetch('/api/payment-links?limit=5', {
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('token')}`
                    }
                });

                if (response.ok) {
                    const data = await response.json();
                    displayLinks(data.links);
                } else {
                    tbody.innerHTML = '<tr><td colspan="6" class="error-cell">Erro ao carregar links</td></tr>';
                }
            } catch (error) {
                console.error('Erro:', error);
                tbody.innerHTML = '<tr><td colspan="6" class="error-cell">Erro ao carregar links</td></tr>';
            }
        }

        // Truncar texto
        function truncateText(text, maxLength = 50) {
            if (!text) return '-';
            if (text.length <= maxLength) return text;
            return text.substr(0, maxLength - 3) + '...';
        }

        // Formatar moeda
        function formatCurrency(value) {
            const num = parseFloat(value);
            if (isNaN(num)) return 'R$ 0,00';
            return num.toLocaleString('pt-BR', {
                style: 'currency',
                currency: 'BRL'
            });
        }

        // Formatar data
        function formatDate(dateString) {
            if (!dateString) return '-';
            const date = new Date(dateString);
            return date.toLocaleDateString('pt-BR') + ' ' + 
                   date.toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit' });
        }

        // Exibir links na tabela
        function displayLinks(links) {
            const tbody = document.getElementById('linksTableBody');
            
            if (!links || links.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="6" class="empty-cell">
                            <p>Nenhum link criado ainda</p>
                            <button onclick="window.location.href='/create-link'" class="btn-primary">
                                Criar Primeiro Link
                            </button>
                        </td>
                    </tr>
                `;
                return;
            }

            tbody.innerHTML = links.map(link => `
                <tr>
                    <td>${truncateText(link.description, 30)}</td>
                    <td class="amount">${formatCurrency(link.amount)}</td>
                    <td>${truncateText(link.customer_name || '-', 20)}</td>
                    <td>
                        <span class="status-badge status-${link.status}">
                            ${getStatusLabel(link.status)}
                        </span>
                    </td>
                    <td>${formatDate(link.created_at)}</td>
                    <td>
                        <div class="action-buttons">
                            <button onclick="copyLink('${link.id}')" class="btn-icon" title="Copiar Link">
                                üìã
                            </button>
                            <button onclick="viewLink('${link.id}')" class="btn-icon" title="Ver Detalhes">
                                üëÅÔ∏è
                            </button>
                        </div>
                    </td>
                </tr>
            `).join('');
        }

        // Obter label do status
        function getStatusLabel(status) {
            const labels = {
                'pending': 'Pendente',
                'paid': 'Pago',
                'expired': 'Expirado',
                'cancelled': 'Cancelado'
            };
            return labels[status] || status;
        }

        // Copiar link
        async function copyLink(linkId) {
            const linkUrl = `${window.location.origin}/pay/${linkId}`;
            
            try {
                await navigator.clipboard.writeText(linkUrl);
                alert('Link copiado!');
            } catch (err) {
                // Fallback para navegadores mais antigos
                const textArea = document.createElement('textarea');
                textArea.value = linkUrl;
                document.body.appendChild(textArea);
                textArea.select();
                document.execCommand('copy');
                document.body.removeChild(textArea);
                alert('Link copiado!');
            }
        }

        // Ver detalhes do link
        function viewLink(linkId) {
            // Por enquanto, apenas copiar o link
            copyLink(linkId);
        }

        // Logout
        function logout() {
            localStorage.clear();
            window.location.href = '/login';
        }

        // Inicializar dashboard
        document.addEventListener('DOMContentLoaded', () => {
            loadUserData();
            loadStats();
            loadLinks();
            
            // Atualizar a cada 30 segundos
            setInterval(() => {
                loadStats();
                loadLinks();
            }, 30000);
        });
    </script>
</body>
</html>
